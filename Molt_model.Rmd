Model Molt Variation
========================================================

This document describes the model of Molt observed in Arizona and how it covaries with energetic demand and resource availability in Mexican wintering grounds

```{r}
#load the Hummingbird data; i.e. the d.f. site.dat
load("/Users/sarah/Desktop/Dropbox/ActiveResearchProjects/Hummingbird_extreme_limits/site.dat.rdata")
#keep only the variables you need
site.dat <- site.dat[, c("LOC", "PriMary.Molt", "yearfac", "mofac")]
#make an ordered categorical variable describing primary molt
ordermolt <- function(x){ordered(x, levels=c("M","R",1:8,0,9,"F","L"))}
site.dat$PriMary.Molt <- ordermolt(site.dat$PriMary.Molt)

```


```{r}
#Calculate quantiles of molt distribution per site & year ('Molt.quant...'). quant.50 indicates the median molt stage at a given site and year


getMOLTquant <- function(quantile.){
  tapply(site.dat$PriMary.Molt, INDEX=list(site.dat$LOC, site.dat$yearfac),
        FUN=quantile, type=1, probs=c(quantile.), na.rm=T)}

MOLT.quant.05 <- ordermolt(levels(site.dat$PriMary.Molt)[as.vector(getMOLTquant(.05))])
MOLT.quant.25 <- ordermolt(levels(site.dat$PriMary.Molt)[as.vector(getMOLTquant(.25))])
MOLT.quant.50 <- ordermolt(levels(site.dat$PriMary.Molt)[as.vector(getMOLTquant(.50))])
MOLT.quant.75 <- ordermolt(levels(site.dat$PriMary.Molt)[as.vector(getMOLTquant(.75))])
MOLT.quant.95 <- ordermolt(levels(site.dat$PriMary.Molt)[as.vector(getMOLTquant(.95))])
MOLT.quants <- cbind.data.frame(MOLT.quant.05, MOLT.quant.25, MOLT.quant.50, MOLT.quant.75, MOLT.quant.95)
rm(MOLT.quant.05, MOLT.quant.25, MOLT.quant.50, MOLT.quant.75, MOLT.quant.95)

# calculate variables to hold the site names ('LOC') and years ('yr') associated with the quantiles
quant.temp <- tapply(site.dat$PriMary.Molt, INDEX=list(site.dat$LOC, site.dat$yearfac),
       FUN=quantile, type=1, probs=c(.05), na.rm=T)
LOC <- rownames(quant.temp)
yr <- rep(colnames(quant.temp), each=length(LOC))
rm(quant.temp)

# calculate the nr of birds in each sample ('n.birds')
n.birds <- as.vector(tapply(site.dat$PriMary.Molt, INDEX=list(site.dat$LOC, site.dat$yearfac),
                 FUN=function(x){length(which(!is.na(x)))}))

#save the new metrics in the d.f. "MOLT.quants"
MOLT.quants <- cbind.data.frame(LOC, yr, n.birds, MOLT.quants)
rm(n.birds, LOC, yr)
```

Load the yearly climate (and NDVI) data which will serve as predictors and merge it with the molt metrics in the data frame 'yearly.molt.stat' to be used for modelling
````{r}
load("/Users/sarah/Desktop/Dropbox/ActiveResearchProjects/Hummingbird_extreme_limits/yearly.climate.rdata")
#gives you yearly.climate
yearly.molt.stat <- merge(x=MOLT.quants,y=yearly.climate,by='yr')
rm(MOLT.quants,yearly.climate)
````

Plot molt responses to a proxy for physiological (yearly.Te.10C.q) demand and resrouce availability (NDVI)
```{r fig.width=7, fig.height=6, warning=FALSE}
require(lattice)
require(latticeExtra)
xyplot(MOLT.quant.50 ~ yearly.Te.10C.q|LOC, data=yearly.molt.stat) + layer(panel.smoother(x, y, method = "lm"))
xyplot(MOLT.quant.50 ~ winterNDVI|LOC, data=yearly.molt.stat) + layer(panel.smoother(x, y, method = "lm"))
```

Load a function ('mod.evaluation') to evaluate hierarchical models
````{r}
source('/Users/sarah/Documents/GitHub/extreme_limits/Model_evaluation_v4.r')
````

Using aforementioned function evaluate hierarchical models of median Molt stage as a linear function of annual physiological demand and resource availability, allowing for a random intercept associated with 'site' 
````{r}
attach(yearly.molt.stat)
#http://www.quantpsy.org/interact/interactions.htm
mod.evaluation(yname='MOLT.quant.50', centering='CGM', stand=T, ordered.fac.treatment = "as.num", log.D=T, R="winterNDVI", D="yearly.Te.10C.q")
detach(yearly.molt.stat)
````
